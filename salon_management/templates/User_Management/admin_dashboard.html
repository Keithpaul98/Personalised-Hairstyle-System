{% extends 'base.html' %}
{% load static %}
{% load report_filters %}

{% block title %}Admin Dashboard{% endblock %}

{% block extra_css %}
<style>
    .sidebar {
        background-color: #4e73df;
        background-image: linear-gradient(180deg, #4e73df 10%, #224abe 100%);
        background-size: cover;
        min-height: 100vh;
        position: fixed;
        z-index: 1;
    }
    
    .sidebar-sticky {
        padding-top: 1rem;
    }
    
    .sidebar .nav-link {
        color: rgba(255, 255, 255, 0.8);
        padding: 0.75rem 1rem;
        margin-bottom: 0.25rem;
        border-radius: 0.25rem;
        transition: all 0.2s;
    }
    
    .sidebar .nav-link:hover, .sidebar .nav-link.active {
        color: #fff;
        background-color: rgba(255, 255, 255, 0.1);
    }
    
    .sidebar .nav-link i {
        margin-right: 0.5rem;
        width: 1.25rem;
        text-align: center;
    }
    
    .content {
        margin-left: 16.66667%;
        padding-top: 1.5rem;
    }
    
    .card {
        border: none;
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
        margin-bottom: 1.5rem;
    }
    
    .card-header {
        background-color: #f8f9fc;
        border-bottom: 1px solid #e3e6f0;
    }
    
    .border-left-primary {
        border-left: 0.25rem solid #4e73df !important;
    }
    
    .border-left-success {
        border-left: 0.25rem solid #1cc88a !important;
    }
    
    .border-left-info {
        border-left: 0.25rem solid #36b9cc !important;
    }
    
    .border-left-warning {
        border-left: 0.25rem solid #f6c23e !important;
    }
    
    .border-left-danger {
        border-left: 0.25rem solid #e74a3b !important;
    }
    
    .text-xs {
        font-size: 0.7rem;
    }
    
    .admin-logo {
        max-width: 80px;
        margin: 0 auto;
    }
    
    @media (max-width: 768px) {
        .sidebar {
            position: static;
            min-height: auto;
        }
        .content {
            margin-left: 0;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <nav class="col-md-2 d-none d-md-block sidebar">
            <div class="sidebar-sticky">
                <div class="text-center mb-4">
                    <img src="{% static 'images/admin-logo.png' %}" alt="Admin Logo" class="admin-logo">
                    <h5 class="text-white mt-2">Impact Looks</h5>
                    <p class="text-white-50 small mb-0">Admin Panel</p>
                </div>
                <div class="nav flex-column">
                    <a class="nav-link {% if active_tab == 'dashboard' %}active{% endif %}" href="#overview">
                        <i class="fas fa-tachometer-alt"></i>Overview
                    </a>
                    <a class="nav-link {% if active_tab == 'services' %}active{% endif %}" href="#categories-section">
                        <i class="fas fa-cut"></i>Services
                    </a>
                    <a class="nav-link {% if active_tab == 'staff' %}active{% endif %}" href="#staff">
                        <i class="fas fa-users"></i>Staff
                    </a>
                    
                    <!-- Appointments Section -->
                    <div class="dropdown-divider my-2 bg-white-50"></div>
                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-2 mb-1 text-white-50">
                        <span>Appointments</span>
                    </h6>
                    <a class="nav-link {% if active_tab == 'admin_appointments' %}active{% endif %}" href="{% url 'appointments:admin_appointments' %}">
                        <i class="fas fa-calendar-alt"></i>Manage Appointments
                    </a>
                    
                    <!-- Management Section -->
                    <div class="dropdown-divider my-2 bg-white-50"></div>
                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-2 mb-1 text-white-50">
                        <span>Management</span>
                    </h6>
                    <a class="nav-link {% if active_tab == 'stock' %}active{% endif %}" href="{% url 'Stock_Management:dashboard' %}">
                        <i class="fas fa-warehouse"></i>Stock Management
                    </a>
                    <a class="nav-link {% if active_tab == 'reports' %}active{% endif %}" href="{% url 'reporting:dashboard' %}">
                        <i class="fas fa-chart-line"></i>Reports Dashboard
                    </a>
                    <div class="dropdown-divider my-3 bg-white-50"></div>
                    <a class="nav-link text-danger" href="{% url 'User_Management:custom_logout' %}">
                        <i class="fas fa-sign-out-alt"></i>Logout
                    </a>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main role="main" class="col-md-9 ml-sm-auto col-lg-10 px-4 content">
            <!-- Page Heading -->
            <div class="d-sm-flex align-items-center justify-content-between mb-4">
                <h1 class="h3 mb-0 text-gray-800">Dashboard</h1>
                <div>
                    <a href="{% url 'Stock_Management:dashboard' %}" class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm mr-2">
                        <i class="fas fa-boxes fa-sm text-white-50 mr-1"></i> Stock Management
                    </a>
                    <a href="{% url 'reporting:dashboard' %}" class="d-none d-sm-inline-block btn btn-sm btn-info shadow-sm">
                        <i class="fas fa-chart-line fa-sm text-white-50 mr-1"></i> Reports
                    </a>
                </div>
            </div>

            <!-- Overview Cards -->
            <div class="row" id="overview">
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card border-left-primary h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                        Today's Appointments
                                    </div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800">{{ todays_appointments }}</div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-calendar-check fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card border-left-success h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                        Monthly Revenue
                                    </div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800">MWK {{ monthly_revenue|floatformat:2 }}</div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-dollar-sign fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card border-left-info h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                        Active Customers
                                    </div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800">{{ active_customers }}</div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-users fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card border-left-warning h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                        Low Stock Items
                                    </div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800">{{ low_stock_count }}</div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-exclamation-triangle fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Staff Management -->
            <div class="card mt-4" id="staff">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Staff Management</h5>
                    <a href="{% url 'User_Management:add_staff' %}" class="btn btn-light">
                        <i class="fas fa-user-plus mr-2"></i>Add Staff
                    </a>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Staff Member</th>
                                    <th>Expertise</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>Rating</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if staff_members %}
                                    {% for staff in staff_members %}
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <img src="{{ staff.profile_picture.url|default:'https://via.placeholder.com/40' }}" 
                                                     alt="{{ staff.get_full_name|default:staff.username }}"
                                                     class="rounded-circle mr-2"
                                                     style="width: 40px; height: 40px; object-fit: cover;">
                                                {{ staff.get_full_name|default:staff.username }}
                                            </div>
                                        </td>
                                        <td>
                                            {% if staff.expertise.all %}
                                                {% for service in staff.expertise.all %}
                                                    {{ service.name }}{% if not forloop.last %}, {% endif %}
                                                {% endfor %}
                                            {% else %}
                                                No expertise specified
                                            {% endif %}
                                        </td>
                                        <td>{{ staff.email }}</td>
                                        <td>{{ staff.phone_number }}</td>
                                        <td>
                                            <div class="rating">
                                                {% if staff.average_rating %}
                                                    {{ staff.average_rating }} / 5
                                                {% else %}
                                                    Not rated
                                                {% endif %}
                                            </div>
                                        </td>
                                        <td>
                                            <a href="{% url 'User_Management:edit_staff' staff.id %}" class="btn btn-sm btn-primary">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <a href="{% url 'User_Management:delete_staff' staff.id %}" class="btn btn-sm btn-danger">
                                                <i class="fas fa-trash"></i>
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="6" class="text-center">No staff members found</td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="card shadow-sm">
                        <div class="card-header">
                            <h5 class="mb-0">Monthly Appointments</h5>
                        </div>
                        <div class="card-body">
                            {% if monthly_appointments and monthly_labels %}
                            <div class="svg-chart-container" style="height: 300px; position: relative;">
                                <svg width="100%" height="100%" viewBox="0 0 800 300" preserveAspectRatio="xMidYMid meet">
                                    <!-- Title -->
                                    <text x="400" y="30" text-anchor="middle" font-size="16" font-weight="bold" fill="#333">Monthly Appointments</text>
                                    
                                    <!-- Grid lines -->
                                    <line x1="50" y1="250" x2="50" y2="50" stroke="#ccc" stroke-width="1" />
                                    <line x1="50" y1="250" x2="750" y2="250" stroke="#ccc" stroke-width="1" />
                                    <line x1="50" y1="200" x2="750" y2="200" stroke="#eee" stroke-width="1" stroke-dasharray="5,5" />
                                    <line x1="50" y1="150" x2="750" y2="150" stroke="#eee" stroke-width="1" stroke-dasharray="5,5" />
                                    <line x1="50" y1="100" x2="750" y2="100" stroke="#eee" stroke-width="1" stroke-dasharray="5,5" />
                                    <line x1="50" y1="50" x2="750" y2="50" stroke="#eee" stroke-width="1" stroke-dasharray="5,5" />
                                    
                                    <!-- Y-axis labels -->
                                    <text x="40" y="250" text-anchor="end" alignment-baseline="middle" font-size="12" fill="#666">0</text>
                                    <text x="40" y="200" text-anchor="end" alignment-baseline="middle" font-size="12" fill="#666">{{ monthly_appointments|max_value|mul:1|div:4|floatformat:"0" }}</text>
                                    <text x="40" y="150" text-anchor="end" alignment-baseline="middle" font-size="12" fill="#666">{{ monthly_appointments|max_value|mul:2|div:4|floatformat:"0" }}</text>
                                    <text x="40" y="100" text-anchor="end" alignment-baseline="middle" font-size="12" fill="#666">{{ monthly_appointments|max_value|mul:3|div:4|floatformat:"0" }}</text>
                                    <text x="40" y="50" text-anchor="end" alignment-baseline="middle" font-size="12" fill="#666">{{ monthly_appointments|max_value|floatformat:"0" }}</text>
                                    
                                    <!-- Bars and labels -->
                                    {% for count in monthly_appointments %}
                                        {% if forloop.counter0 < monthly_labels|length %}
                                            <!-- Bar -->
                                            <rect 
                                                x="{{ 75|add:forloop.counter0|mul:650|div:monthly_labels|length|add:50 }}" 
                                                y="{{ 250|add:'-'|add:count|mul:200|div:monthly_appointments|max_value }}" 
                                                width="{{ 650|div:monthly_labels|length|add:'-10' }}" 
                                                height="{{ count|mul:200|div:monthly_appointments|max_value }}" 
                                                fill="rgba(54, 162, 235, 0.6)" 
                                                stroke="rgba(54, 162, 235, 1)" 
                                                stroke-width="1" 
                                            />
                                            
                                            <!-- X-axis label -->
                                            <text 
                                                x="{{ 75|add:forloop.counter0|mul:650|div:monthly_labels|length|add:50|add:650|div:monthly_labels|length|div:2 }}" 
                                                y="270" 
                                                text-anchor="middle" 
                                                font-size="12" 
                                                fill="#666" 
                                                transform="rotate(45, {{ 75|add:forloop.counter0|mul:650|div:monthly_labels|length|add:50|add:650|div:monthly_labels|length|div:2 }}, 270)"
                                            >
                                                {{ monthly_labels|index:forloop.counter0 }}
                                            </text>
                                        {% endif %}
                                    {% endfor %}
                                </svg>
                            </div>
                            {% else %}
                            <div class="text-center py-5">
                                <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                                <p class="mb-0">No appointment data available for this period. Data will appear here once appointments are scheduled.</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card shadow-sm">
                        <div class="card-header">
                            <h5 class="mb-0">Revenue Analysis</h5>
                        </div>
                        <div class="card-body">
                            {% if monthly_revenue %}
                            <div class="svg-chart-container" style="height: 300px; position: relative;">
                                <svg width="100%" height="100%" viewBox="0 0 800 300" preserveAspectRatio="xMidYMid meet">
                                    <!-- Title -->
                                    <text x="400" y="30" text-anchor="middle" font-size="16" font-weight="bold" fill="#333">Monthly Revenue</text>
                                    
                                    <!-- Grid lines -->
                                    <line x1="50" y1="250" x2="50" y2="50" stroke="#ccc" stroke-width="1" />
                                    <line x1="50" y1="250" x2="750" y2="250" stroke="#ccc" stroke-width="1" />
                                    <line x1="50" y1="200" x2="750" y2="200" stroke="#eee" stroke-width="1" stroke-dasharray="5,5" />
                                    <line x1="50" y1="150" x2="750" y2="150" stroke="#eee" stroke-width="1" stroke-dasharray="5,5" />
                                    <line x1="50" y1="100" x2="750" y2="100" stroke="#eee" stroke-width="1" stroke-dasharray="5,5" />
                                    <line x1="50" y1="50" x2="750" y2="50" stroke="#eee" stroke-width="1" stroke-dasharray="5,5" />
                                    
                                    <!-- Y-axis labels -->
                                    <text x="40" y="250" text-anchor="end" alignment-baseline="middle" font-size="12" fill="#666">MWK 0</text>
                                    <text x="40" y="200" text-anchor="end" alignment-baseline="middle" font-size="12" fill="#666">MWK {{ monthly_revenue|max_value|mul:0.25|floatformat:"0" }}</text>
                                    <text x="40" y="150" text-anchor="end" alignment-baseline="middle" font-size="12" fill="#666">MWK {{ monthly_revenue|max_value|mul:0.5|floatformat:"0" }}</text>
                                    <text x="40" y="100" text-anchor="end" alignment-baseline="middle" font-size="12" fill="#666">MWK {{ monthly_revenue|max_value|mul:0.75|floatformat:"0" }}</text>
                                    <text x="40" y="50" text-anchor="end" alignment-baseline="middle" font-size="12" fill="#666">MWK {{ monthly_revenue|max_value|floatformat:"0" }}</text>
                                    
                                    <!-- X-axis labels -->
                                    {% for month in monthly_labels %}
                                    <text 
                                        x="{{ 50|add:forloop.counter0|mul:700|div:monthly_labels|length|add:700|div:monthly_labels|length|div:2 }}" 
                                        y="270" 
                                        text-anchor="middle" 
                                        font-size="12" 
                                        fill="#666"
                                    >{{ month }}</text>
                                    {% endfor %}
                                    
                                    <!-- Line chart -->
                                    <polyline 
                                        points="
                                        {% for amount in monthly_revenue %}
                                            {% with x_pos=forloop.counter0|mul:700|div:12|add:50 %}
                                            {% with y_pos=250|sub:amount|mul:200|div:monthly_revenue|max_value %}
                                            {{ x_pos }},{{ y_pos }}
                                            {% endwith %}
                                            {% endwith %}
                                        {% endfor %}
                                        "
                                        fill="none" 
                                        stroke="rgba(75, 192, 192, 1)" 
                                        stroke-width="2"
                                    />
                                    
                                    <!-- Points and labels -->
                                    {% for amount in monthly_revenue %}
                                        {% with x_pos=forloop.counter0|mul:700|div:12|add:50 %}
                                        {% with y_pos=250|sub:amount|mul:200|div:monthly_revenue|max_value %}
                                        <!-- Point -->
                                        <circle 
                                            cx="{{ x_pos }}" 
                                            cy="{{ y_pos }}" 
                                            r="4" 
                                            fill="white" 
                                            stroke="rgba(75, 192, 192, 1)" 
                                            stroke-width="2" 
                                        />
                                        
                                        <!-- Value label -->
                                        <text 
                                            x="{{ x_pos }}" 
                                            y="{{ y_pos|sub:10 }}" 
                                            text-anchor="middle" 
                                            font-size="10" 
                                            fill="#333"
                                        >MWK {{ amount|floatformat:"0" }}</text>
                                        {% endwith %}
                                        {% endwith %}
                                    {% endfor %}
                                </svg>
                            </div>
                            {% else %}
                            <div class="text-center py-5">
                                <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                                <p class="mb-0">No revenue data available for this period. Data will appear here once transactions are recorded.</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reports Section -->
            <div class="card mt-4">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-chart-bar mr-2"></i>Reports</h5>
                    <button class="btn btn-light" data-toggle="modal" data-target="#generateReportModal">
                        <i class="fas fa-file-download mr-2"></i>Generate Report
                    </button>
                </div>
                <div class="card-body">
                    <div class="row mb-4">
                        <!-- Quick Report Links -->
                        <div class="col-md-4">
                            <div class="card h-100 border-left-warning shadow-sm">
                                <div class="card-body">
                                    <div class="row no-gutters align-items-center">
                                        <div class="col mr-2">
                                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                                Sales vs. Salon Usage
                                            </div>
                                            <div class="small mb-0 font-weight-bold text-gray-800">Compare retail sales with salon usage</div>
                                        </div>
                                        <div class="col-auto">
                                            <i class="fas fa-balance-scale fa-2x text-gray-300"></i>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-footer bg-light">
                                    <a href="{% url 'reporting:sales_vs_salon_report' %}" class="btn btn-sm btn-warning">
                                        <i class="fas fa-chart-bar mr-1"></i> View Report
                                    </a>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="card h-100 border-left-primary shadow-sm">
                                <div class="card-body">
                                    <div class="row no-gutters align-items-center">
                                        <div class="col mr-2">
                                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                                Inventory Analysis
                                            </div>
                                            <div class="small mb-0 font-weight-bold text-gray-800">Stock levels and inventory value</div>
                                        </div>
                                        <div class="col-auto">
                                            <i class="fas fa-boxes fa-2x text-gray-300"></i>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-footer bg-light">
                                    <a href="{% url 'reporting:dashboard' %}" class="btn btn-sm btn-primary">
                                        <i class="fas fa-chart-pie mr-1"></i> View Reports
                                    </a>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="card h-100 border-left-success shadow-sm">
                                <div class="card-body">
                                    <div class="row no-gutters align-items-center">
                                        <div class="col mr-2">
                                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                                Business Overview
                                            </div>
                                            <div class="small mb-0 font-weight-bold text-gray-800">Complete business performance</div>
                                        </div>
                                        <div class="col-auto">
                                            <i class="fas fa-chart-line fa-2x text-gray-300"></i>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-footer bg-light">
                                    <button class="btn btn-sm btn-success" data-toggle="modal" data-target="#generateReportModal">
                                        <i class="fas fa-file-download mr-1"></i> Generate
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Report Type</th>
                                    <th>Period</th>
                                    <th>Generated Date</th>
                                    <th>Generated By</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for report in recent_reports %}
                                <tr>
                                    <td>{{ report.get_report_type_display }}</td>
                                    <td>{{ report.start_date|date:"M d, Y" }} - {{ report.end_date|date:"M d, Y" }}</td>
                                    <td>{{ report.created_at|date:"M d, Y H:i" }}</td>
                                    <td>{{ report.generated_by.get_full_name }}</td>
                                    <td>
                                        {% if report.file %}
                                        <a href="{{ report.file.url }}" class="btn btn-sm btn-success">
                                            <i class="fas fa-download"></i>
                                        </a>
                                        {% endif %}
                                        <button class="btn btn-sm btn-danger delete-report" data-report-id="{{ report.id }}">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5" class="text-center">No reports generated yet</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Add this section to your admin dashboard -->
            <div class="card mb-4" id="categories-section">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-cut mr-2"></i>Services Management
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <a href="{% url 'User_Management:add_service' %}" class="btn btn-primary">
                            <i class="fas fa-plus mr-2"></i>Add New Service
                        </a>
                    </div>
                    
                    {% if categories %}
                        {% for category in categories %}
                            <h6 class="mt-4">{{ category.get_name_display }}</h6>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Service Name</th>
                                            <th>Price</th>
                                            <th>Duration</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for service in category.service_set.all %}
                                            <tr>
                                                <td>{{ service.name }}</td>
                                                <td>MWK {{ service.price }}</td>
                                                <td>{{ service.duration }}</td>
                                                <td>
                                                    {% if service.is_active %}
                                                        <span class="badge badge-success">Active</span>
                                                    {% else %}
                                                        <span class="badge badge-danger">Inactive</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <a href="{% url 'User_Management:edit_service' service.id %}" 
                                                       class="btn btn-sm btn-info">
                                                        <i class="fas fa-edit"></i>
                                                    </a>
                                                    <button type="button" 
                                                            class="btn btn-sm btn-danger"
                                                            data-toggle="modal"
                                                            data-target="#deleteServiceModal{{ service.id }}">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                            
                                            <!-- Delete Modal for each service -->
                                            <div class="modal fade" id="deleteServiceModal{{ service.id }}" tabindex="-1">
                                                <div class="modal-dialog">
                                                    <div class="modal-content">
                                                        <div class="modal-header">
                                                            <h5 class="modal-title">Delete Service</h5>
                                                            <button type="button" class="close" data-dismiss="modal">
                                                                <span>&times;</span>
                                                            </button>
                                                        </div>
                                                        <div class="modal-body">
                                                            Are you sure you want to delete "{{ service.name }}"?
                                                        </div>
                                                        <div class="modal-footer">
                                                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                                                            <a href="{% url 'User_Management:delete_service' service.id %}" 
                                                               class="btn btn-danger">Delete</a>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted">No services added yet.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Inventory Section -->
            <div class="card shadow mb-4" id="inventory">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Inventory Management</h6>
                    <a href="{% url 'Stock_Management:product_list' %}" class="btn btn-sm btn-primary shadow-sm">
                        <i class="fas fa-boxes fa-sm text-white-50 mr-1"></i> View All Products
                    </a>
                </div>
                <div class="card-body">
                    <!-- Sales vs. Salon Usage Overview -->
                    <div class="row mb-4">
                        <div class="col-lg-6">
                            <div class="card border-left-primary h-100">
                                <div class="card-header py-3">
                                    <h6 class="m-0 font-weight-bold text-primary">Sales vs. Salon Usage</h6>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container" style="position: relative; height: 250px;">
                                        <!-- SVG chart for usage ratio -->
                                        <svg width="100%" height="250" viewBox="0 0 400 250" style="background-color: white;">
                                            <!-- Title -->
                                            <text x="200" y="30" text-anchor="middle" font-size="14" font-weight="bold">Product Usage Distribution</text>
                                            
                                            <!-- Pie chart -->
                                            <circle cx="200" cy="120" r="80" fill="#f8f9fc" stroke="#dddfeb" stroke-width="1" />
                                            
                                            <!-- Retail Sales slice -->
                                            {% if retail_percentage > 50 %}
                                            <path d="M 200 120 L 200 40 A 80 80 0 1 1 120 160 Z" fill="#4e73df" />
                                            {% else %}
                                            <path d="M 200 120 L 200 40 A 80 80 0 0 1 120 160 Z" fill="#4e73df" />
                                            {% endif %}
                                            
                                            <!-- Salon Usage slice -->
                                            <path d="M 200 120 L 120 160 A 80 80 0 0 1 200 40 Z" fill="#1cc88a" />
                                            
                                            <!-- Labels -->
                                            <text x="300" y="100" text-anchor="middle" font-size="12" fill="#4e73df" font-weight="bold">Retail Sales: {{ retail_percentage }}%</text>
                                            <text x="300" y="130" text-anchor="middle" font-size="12" fill="#1cc88a" font-weight="bold">Salon Usage: {{ salon_percentage }}%</text>
                                            
                                            <!-- Legend -->
                                            <rect x="260" y="90" width="12" height="12" fill="#4e73df" rx="2" ry="2" />
                                            <rect x="260" y="120" width="12" height="12" fill="#1cc88a" rx="2" ry="2" />
                                        </svg>
                                    </div>
                                    <div class="text-center mt-2">
                                        <a href="{% url 'reporting:sales_vs_salon_report' %}" class="btn btn-sm btn-primary">
                                            <i class="fas fa-chart-pie mr-1"></i> View Detailed Report
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-lg-6">
                            <div class="card border-left-warning h-100">
                                <div class="card-header py-3">
                                    <h6 class="m-0 font-weight-bold text-warning">Low Stock Alert</h6>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Product</th>
                                                    <th>Current Stock</th>
                                                    <th>Min. Stock</th>
                                                    <th>Status</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for product in low_stock_products|slice:":5" %}
                                                <tr>
                                                    <td>{{ product.name }}</td>
                                                    <td>{{ product.current_stock }}</td>
                                                    <td>{{ product.minimum_stock }}</td>
                                                    <td>
                                                        {% if product.current_stock == 0 %}
                                                            <span class="badge badge-danger">Out of Stock</span>
                                                        {% else %}
                                                            <span class="badge badge-warning">Low Stock</span>
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                                {% empty %}
                                                <tr>
                                                    <td colspan="4" class="text-center">No low stock items</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="text-center mt-2">
                                        <a href="{% url 'Stock_Management:low_stock_report' %}" class="btn btn-sm btn-warning">
                                            <i class="fas fa-exclamation-triangle mr-1"></i> View All Low Stock
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Top Products Section -->
                    <div class="row">
                        <div class="col-lg-6">
                            <div class="card border-left-success h-100">
                                <div class="card-header py-3">
                                    <h6 class="m-0 font-weight-bold text-success">Top Retail Products</h6>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Product</th>
                                                    <th>Category</th>
                                                    <th>Price</th>
                                                    <th>Sales</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for product in top_retail_products|slice:":5" %}
                                                <tr>
                                                    <td>{{ product.name }}</td>
                                                    <td>{{ product.category.name }}</td>
                                                    <td>MWK {{ product.price }}</td>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <div class="mr-2">{{ product.total_sold }}</div>
                                                            <div class="progress" style="width: 60px; height: 6px;">
                                                                <div class="progress-bar bg-success" role="progressbar" 
                                                                    style="width: {{ product.percentage }}%"></div>
                                                            </div>
                                                        </div>
                                                    </td>
                                                </tr>
                                                {% empty %}
                                                <tr>
                                                    <td colspan="4" class="text-center">No retail sales data available</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-lg-6">
                            <div class="card border-left-info h-100">
                                <div class="card-header py-3">
                                    <h6 class="m-0 font-weight-bold text-info">Top Salon Usage Products</h6>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Product</th>
                                                    <th>Category</th>
                                                    <th>Usage</th>
                                                    <th>Frequency</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for product in top_salon_products|slice:":5" %}
                                                <tr>
                                                    <td>{{ product.name }}</td>
                                                    <td>{{ product.category.name }}</td>
                                                    <td>{{ product.total_used }}</td>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <div class="mr-2">{{ product.frequency }}</div>
                                                            <div class="progress" style="width: 60px; height: 6px;">
                                                                <div class="progress-bar bg-info" role="progressbar" 
                                                                    style="width: {{ product.percentage }}%"></div>
                                                            </div>
                                                        </div>
                                                    </td>
                                                </tr>
                                                {% empty %}
                                                <tr>
                                                    <td colspan="4" class="text-center">No salon usage data available</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- Add Service Modal -->
<div class="modal fade" id="addServiceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Service</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <form method="POST" action="{% url 'User_Management:add_service' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="form-group">
                        <label>Service Name</label>
                        <input type="text" name="name" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Duration (minutes)</label>
                        <input type="number" name="duration" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Price (MWK)</label>
                        <input type="number" name="price" step="0.01" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea name="description" class="form-control" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Service</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Staff Modal -->
<div class="modal fade" id="addStaffModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Staff Member</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <form method="POST" action="{% url 'User_Management:add_staff' %}" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" name="name" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Specialization</label>
                        <input type="text" name="specialization" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Contact</label>
                        <input type="tel" name="contact" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Profile Image</label>
                        <input type="file" name="image" class="form-control-file">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Staff Member</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Generate Report Modal -->
<div class="modal fade" id="generateReportModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Generate Report</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <form method="POST" action="{% url 'reporting:generate_report' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="form-group">
                        <label>Report Type</label>
                        <select name="report_type" class="form-control" required>
                            <option value="sales">Sales Report</option>
                            <option value="services">Services Report</option>
                            <option value="customers">Customer Analytics</option>
                            <option value="hairstyles">Popular Styles</option>
                            <option value="appointments">Appointment Statistics</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Period</label>
                        <select name="period" class="form-control" id="reportPeriod" required>
                            <option value="DAILY">Daily</option>
                            <option value="WEEKLY">Weekly</option>
                            <option value="MONTHLY">Monthly</option>
                            <option value="YEARLY">Yearly</option>
                            <option value="CUSTOM">Custom Range</option>
                        </select>
                    </div>
                    <div id="customDateRange" style="display: none;">
                        <div class="form-group">
                            <label>Start Date</label>
                            <input type="date" name="start_date" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>End Date</label>
                            <input type="date" name="end_date" class="form-control">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Generate</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Delete confirmations
$('.delete-service').click(function() {
    if (confirm('Are you sure you want to delete this service?')) {
        const serviceId = $(this).data('service-id');
        window.location.href = `/delete-service/${serviceId}/`;
    }
});

$('.delete-staff').click(function() {
    if (confirm('Are you sure you want to delete this staff member?')) {
        const staffId = $(this).data('staff-id');
        window.location.href = `/delete-staff/${staffId}/`;
    }
});

// Report period selection
$('#reportPeriod').change(function() {
    if ($(this).val() === 'CUSTOM') {
        $('#customDateRange').show();
    } else {
        $('#customDateRange').hide();
    }
});

// Delete report confirmation
$('.delete-report').click(function() {
    if (confirm('Are you sure you want to delete this report?')) {
        const reportId = $(this).data('report-id');
        window.location.href = `/reports/delete/${reportId}/`;
    }
});
</script>
{% endblock %}
