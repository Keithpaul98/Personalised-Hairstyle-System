{% extends 'base.html' %}
{% load static %}

{% block title %}{{ report.title }}{% endblock %}

{% block extra_css %}
<style>
    .chart-container {
        position: relative;
        height: 300px;
        margin-bottom: 20px;
    }
    .report-section {
        margin-bottom: 30px;
    }
    .report-header {
        padding: 20px;
        background-color: #f8f9fa;
        border-radius: 5px;
        margin-bottom: 20px;
    }
    .metric-card {
        text-align: center;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 15px;
    }
    .metric-card h3 {
        margin-bottom: 5px;
        font-weight: bold;
    }
    .metric-card p {
        margin-bottom: 0;
        font-size: 0.9rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>{{ report.title }}</h2>
        <div class="btn-group">
            <a href="{% url 'reporting:export_pdf' report.id %}" class="btn btn-danger">
                <i class="fas fa-file-pdf"></i> Export as PDF
            </a>
            <a href="{% url 'reporting:export_csv' report.id %}" class="btn btn-success">
                <i class="fas fa-file-csv"></i> Export as CSV
            </a>
            <a href="{% url 'reporting:dashboard' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to Dashboard
            </a>
        </div>
    </div>

    <!-- Debug Information - Only visible to admins -->
    {% if user.role == 'admin' %}
    <div class="alert alert-info mb-4">
        <h5><i class="fas fa-bug"></i> Debug Information</h5>
        <p>This section helps identify why charts might not be displaying properly.</p>
        <div id="debugInfo"></div>
    </div>
    {% endif %}

    <!-- Report Header -->
    <div class="report-header">
        <div class="row">
            <div class="col-md-6">
                <p><strong>Report Type:</strong> {{ report.get_report_type_display }}</p>
                <p><strong>Date Range:</strong> {{ report.date_range_start|date:"F d, Y" }} - {{ report.date_range_end|date:"F d, Y" }}</p>
                <p><strong>Generated:</strong> {{ report.date_generated|date:"F d, Y H:i" }}</p>
            </div>
            <div class="col-md-6">
                <p><strong>Generated By:</strong> {{ report.generated_by.username }}</p>
                <p><strong>Report ID:</strong> {{ report.id }}</p>
            </div>
        </div>
    </div>

    <!-- Key Metrics -->
    <div class="report-section">
        <h4 class="mb-3">Key Metrics</h4>
        <div class="row">
            <div class="col-md-3">
                <div class="metric-card bg-primary text-white">
                    <h3>${{ report.total_revenue }}</h3>
                    <p>Total Revenue</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card bg-success text-white">
                    <h3>{{ report.total_appointments }}</h3>
                    <p>Total Appointments</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card bg-info text-white">
                    <h3>{{ report.total_products }}</h3>
                    <p>Total Products</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card bg-warning text-dark">
                    <h3>{{ report.products_sold }}</h3>
                    <p>Products Sold</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Business Report Specific Content -->
    {% if report.report_type == 'business' %}
    <div class="report-section">
        <h4 class="mb-3">Business Overview</h4>
        
        <!-- Revenue Chart -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Revenue Breakdown</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Appointments Chart -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Appointment Status</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="appointmentChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Sales Report Specific Content -->
    {% if report.report_type == 'sales' %}
    <div class="report-section">
        <h4 class="mb-3">Sales Analysis</h4>
        
        <!-- Sales Trend Chart -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Sales Trend</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <!-- SVG chart for sales trend -->
                    <svg width="100%" height="300" viewBox="0 0 600 300" style="background-color: white;">
                        <!-- Title -->
                        <text x="300" y="30" text-anchor="middle" font-size="16" font-weight="bold">Daily Sales Trend</text>
                        
                        <!-- X-axis -->
                        <line x1="50" y1="250" x2="550" y2="250" stroke="#ccc" stroke-width="1" />
                        <!-- Y-axis -->
                        <line x1="50" y1="250" x2="50" y2="50" stroke="#ccc" stroke-width="1" />
                        
                        <!-- X-axis labels (dates) -->
                        {% if report.json_data.daily_sales %}
                            {% with daily_sales_length=report.json_data.daily_sales|length %}
                                {% for item in report.json_data.daily_sales %}
                                    {% if forloop.counter0|divisibleby:3 or forloop.first or forloop.last %}
                                        <text 
                                            x="{{ forloop.counter0|mul:500|div:daily_sales_length|add:50 }}" 
                                            y="270" 
                                            text-anchor="middle" 
                                            font-size="10" 
                                            fill="#333333"
                                            transform="rotate(45, {{ forloop.counter0|mul:500|div:daily_sales_length|add:50 }}, 270)">
                                            {{ item.date|slice:"5:" }}
                                        </text>
                                    {% endif %}
                                {% endfor %}
                                
                                <!-- Find max value for scaling -->
                                {% with max_value=0 %}
                                    {% for item in report.json_data.daily_sales %}
                                        {% if item.total_revenue > max_value %}
                                            {% with max_value=item.total_revenue %}{% endwith %}
                                        {% endif %}
                                    {% endfor %}
                                    
                                    {% if max_value > 0 %}
                                        <!-- Line chart for sales trend -->
                                        <polyline 
                                            points="
                                            {% for item in report.json_data.daily_sales %}
                                                {{ forloop.counter0|mul:500|div:daily_sales_length|add:50 }},{{ 250|sub:item.total_revenue|mul:200|div:max_value|add:50 }}
                                            {% endfor %}
                                            "
                                            fill="none"
                                            stroke="#4e73df"
                                            stroke-width="2"
                                        />
                                        
                                        <!-- Data points -->
                                        {% for item in report.json_data.daily_sales %}
                                            <circle 
                                                cx="{{ forloop.counter0|mul:500|div:daily_sales_length|add:50 }}" 
                                                cy="{{ 250|sub:item.total_revenue|mul:200|div:max_value|add:50 }}" 
                                                r="4" 
                                                fill="#4e73df" 
                                            />
                                        {% endfor %}
                                    {% else %}
                                        <!-- Show a message when all values are zero -->
                                        <text x="300" y="150" text-anchor="middle" font-size="14">No revenue data available for this period</text>
                                    {% endif %}
                                {% endwith %}
                            {% endwith %}
                        {% else %}
                            <text x="300" y="150" text-anchor="middle" font-size="14">No sales trend data available</text>
                        {% endif %}
                    </svg>
                </div>
            </div>
        </div>
        
        <!-- Product vs Service Revenue -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Product vs Service Revenue</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <!-- SVG chart for product vs service revenue -->
                    <svg width="100%" height="300" viewBox="0 0 400 300" style="background-color: white;">
                        <!-- Title -->
                        <text x="200" y="30" text-anchor="middle" font-size="16" font-weight="bold">Revenue Distribution</text>
                        
                        <!-- Pie chart -->
                        {% if report.json_data.revenue_breakdown %}
                            {% with product_revenue=report.json_data.revenue_breakdown.data.0 %}
                            {% with service_revenue=report.json_data.revenue_breakdown.data.1 %}
                            {% with total_revenue=product_revenue|add:service_revenue %}
                                {% if total_revenue > 0 %}
                                    {% with product_percentage=product_revenue|div:total_revenue|mul:100 %}
                                    {% with service_percentage=service_revenue|div:total_revenue|mul:100 %}
                                    {% with product_angle=product_percentage|mul:3.6 %}
                                    {% with service_angle=service_percentage|mul:3.6 %}
                                        <!-- Service Revenue slice (starts at 12 o'clock) -->
                                        <path d="M 200 150 L 200 50 A 100 100 0 {{ service_angle|div:360|mul:1|add:0|floatformat:0 }} 1 {{ 200|add:100|mul:service_angle|div:360|sub:100|floatformat:0 }} {{ 150|sub:100|mul:service_angle|div:360|add:100|floatformat:0 }} Z" fill="#1cc88a" />
                                        
                                        <!-- Product Revenue slice -->
                                        <path d="M 200 150 L {{ 200|add:100|mul:service_angle|div:360|sub:100|floatformat:0 }} {{ 150|sub:100|mul:service_angle|div:360|add:100|floatformat:0 }} A 100 100 0 {{ product_angle|div:360|mul:1|add:0|floatformat:0 }} 1 200 50 Z" fill="#4e73df" />
                                        
                                        <!-- Labels -->
                                        <text x="200" y="220" text-anchor="middle" font-size="14" font-weight="bold">
                                            Products: {{ product_percentage|floatformat:1 }}% (MWK {{ product_revenue|floatformat:2 }})
                                        </text>
                                        <text x="200" y="245" text-anchor="middle" font-size="14" font-weight="bold">
                                            Services: {{ service_percentage|floatformat:1 }}% (MWK {{ service_revenue|floatformat:2 }})
                                        </text>
                                        
                                        <!-- Legend -->
                                        <rect x="80" y="270" width="15" height="15" fill="#4e73df" rx="2" ry="2" />
                                        <text x="100" y="283" font-size="12" fill="#333333">Products</text>
                                        <rect x="250" y="270" width="15" height="15" fill="#1cc88a" rx="2" ry="2" />
                                        <text x="270" y="283" font-size="12" fill="#333333">Services</text>
                                    {% endwith %}
                                    {% endwith %}
                                    {% endwith %}
                                    {% endwith %}
                                {% else %}
                                    <!-- Show a message when no revenue data is available -->
                                    <text x="200" y="150" text-anchor="middle" font-size="14">No revenue data available</text>
                                {% endif %}
                            {% endwith %}
                            {% endwith %}
                            {% endwith %}
                        {% else %}
                            <text x="200" y="150" text-anchor="middle" font-size="14">No revenue data available</text>
                        {% endif %}
                    </svg>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Appointments Report Specific Content -->
    {% if report.report_type == 'appointments' %}
    <div class="report-section">
        <h4 class="mb-3">Appointment Analysis</h4>
        
        <!-- Appointment Status Chart -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Appointment Status</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="appointmentStatusChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Appointments by Day -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Appointments by Day</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="appointmentsByDayChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Stylists Report Specific Content -->
    {% if report.report_type == 'stylists' %}
    <div class="report-section">
        <h4 class="mb-3">Stylist Performance</h4>
        
        <!-- Stylist Appointments Chart -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Appointments by Stylist</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="stylistAppointmentsChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Stylist Revenue Chart -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Revenue by Stylist</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="stylistRevenueChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Customers Report Specific Content -->
    {% if report.report_type == 'customers' %}
    <div class="report-section">
        <h4 class="mb-3">Customer Analysis</h4>
        
        <!-- New vs Returning Customers -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">New vs Returning Customers</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="customerTypeChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Customer Spending -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Customer Spending Distribution</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="customerSpendingChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Inventory Report Specific Content -->
    {% if report.report_type == 'inventory' %}
    <div class="report-section">
        <h4 class="mb-3">Inventory Analysis</h4>
        
        <!-- Top Selling Products -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Top Selling Products</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="topProductsChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Stock Levels -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Current Stock Levels</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Category</th>
                                <th>Current Stock</th>
                                <th>Reorder Level</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for product in inventory_data %}
                            <tr>
                                <td>{{ product.name }}</td>
                                <td>{{ product.category }}</td>
                                <td>{{ product.current_stock }}</td>
                                <td>{{ product.reorder_level }}</td>
                                <td>
                                    {% if product.current_stock <= product.reorder_level %}
                                    <span class="badge bg-danger">Low Stock</span>
                                    {% else %}
                                    <span class="badge bg-success">In Stock</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Services Report Specific Content -->
    {% if report.report_type == 'services' %}
    <div class="report-section">
        <h4 class="mb-3">Services Analysis</h4>
        
        <!-- Popular Services -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Most Popular Services</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="popularServicesChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Service Revenue -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Service Revenue</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="serviceRevenueChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Hairstyles Report Specific Content -->
    {% if report.report_type == 'hairstyles' %}
    <div class="report-section">
        <h4 class="mb-3">Hairstyle Analysis</h4>
        
        <!-- Popular Hairstyles -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Most Popular Hairstyles</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="popularHairstylesChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Virtual Try-on vs Actual Bookings -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Virtual Try-on vs Actual Bookings</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="tryonVsBookingChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Hairstyle Analytics -->
    {% if report.report_type == 'hairstyles' and hairstyle_analytics %}
    <div class="report-section">
        <h3>Hairstyle Analytics</h3>
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Hairstyle</th>
                        <th>Try-On Count</th>
                        <th>Booking Count</th>
                        <th>Popularity Rank</th>
                    </tr>
                </thead>
                <tbody>
                    {% for hairstyle in hairstyle_analytics %}
                    <tr>
                        <td>{{ hairstyle.hairstyle_name }}</td>
                        <td>{{ hairstyle.try_on_count }}</td>
                        <td>{{ hairstyle.booking_count }}</td>
                        <td>{{ hairstyle.popularity_rank }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- System-Wide Report: Sales vs. Salon Usage -->
    {% if report.report_type == 'system_wide' and report.json_data %}
    <div class="report-section">
        <h3><i class="fas fa-balance-scale me-2 text-warning"></i> Sales vs. Salon Usage Analysis</h3>
        
        <!-- Summary Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="metric-card bg-primary text-white">
                    <h3>{{ report.json_data.retail_sales.total_quantity }}</h3>
                    <p class="mb-0">Retail Units Sold</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card bg-success text-white">
                    <h3>{{ report.json_data.salon_usage.total_quantity }}</h3>
                    <p class="mb-0">Salon Units Used</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card bg-info text-white">
                    <h3>MWK {{ report.json_data.retail_sales.total_value|floatformat:2 }}</h3>
                    <p class="mb-0">Retail Sales Value</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card bg-warning text-dark">
                    <h3>MWK {{ report.json_data.salon_usage.total_value|floatformat:2 }}</h3>
                    <p class="mb-0">Salon Usage Value</p>
                </div>
            </div>
        </div>
        
        <!-- Usage Ratio Analysis -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="fas fa-percentage me-2 text-info"></i> Usage Ratio</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <!-- SVG chart for usage ratio -->
                            <svg width="100%" height="300" viewBox="0 0 400 300" style="background-color: white;">
                                <!-- Title -->
                                <text x="200" y="30" text-anchor="middle" font-size="16" font-weight="bold">Retail vs. Salon Usage Ratio</text>
                                
                                <!-- Pie chart -->
                                {% if report.json_data.retail_percentage > 0 or report.json_data.salon_percentage > 0 %}
                                    {% with sales_percentage=report.json_data.retail_percentage %}
                                    {% with salon_percentage=report.json_data.salon_percentage %}
                                    {% with sales_angle=sales_percentage|mul:3.6 %}
                                    {% with salon_angle=salon_percentage|mul:3.6 %}
                                        <!-- Salon Usage slice -->
                                        <path d="M 200 150 L 200 50 A 100 100 0 {{ salon_angle|div:360|mul:1|add:0|floatformat:0 }} 1 {{ 200|add:100|mul:salon_angle|div:360|sub:100|floatformat:0 }} {{ 150|sub:100|mul:salon_angle|div:360|add:100|floatformat:0 }} Z" fill="#1cc88a" />
                                        
                                        <!-- Retail Sales slice -->
                                        <path d="M 200 150 L {{ 200|add:100|mul:salon_angle|div:360|sub:100|floatformat:0 }} {{ 150|sub:100|mul:salon_angle|div:360|add:100|floatformat:0 }} A 100 100 0 {{ sales_angle|div:360|mul:1|add:0|floatformat:0 }} 1 200 50 Z" fill="#4e73df" />
                                        
                                        <!-- Labels -->
                                        <text x="200" y="220" text-anchor="middle" font-size="14" font-weight="bold">
                                            Retail: {{ sales_percentage|floatformat:1 }}% ({{ report.json_data.retail_sales.total_quantity }} units)
                                        </text>
                                        <text x="200" y="245" text-anchor="middle" font-size="14" font-weight="bold">
                                            Salon: {{ salon_percentage|floatformat:1 }}% ({{ report.json_data.salon_usage.total_quantity }} units)
                                        </text>
                                    {% endwith %}
                                    {% endwith %}
                                    {% endwith %}
                                    {% endwith %}
                                {% else %}
                                    <text x="200" y="150" text-anchor="middle" font-size="14">No data available</text>
                                {% endif %}
                            </svg>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="fas fa-chart-line me-2 text-success"></i> Monthly Comparison</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <!-- SVG chart for monthly comparison -->
                            <svg width="100%" height="300" viewBox="0 0 600 300" style="background-color: white;">
                                <!-- Title -->
                                <text x="300" y="30" text-anchor="middle" font-size="16" font-weight="bold">Monthly Product Usage</text>
                                
                                <!-- X-axis -->
                                <line x1="50" y1="250" x2="550" y2="250" stroke="#ccc" stroke-width="1" />
                                <!-- Y-axis -->
                                <line x1="50" y1="250" x2="50" y2="50" stroke="#ccc" stroke-width="1" />
                                
                                <!-- X-axis labels (months) -->
                                {% for item in report.json_data.monthly_comparison %}
                                    <text 
                                        x="{{ forloop.counter0|mul:65|add:85 }}" 
                                        y="270" 
                                        text-anchor="middle" 
                                        font-size="12" 
                                        fill="#333333">
                                        {{ item.month }}
                                    </text>
                                {% endfor %}
                                
                                <!-- Bars for retail sales -->
                                {% for item in report.json_data.monthly_comparison %}
                                    <rect 
                                        x="{{ forloop.counter0|mul:65|add:70 }}" 
                                        y="{{ 250|sub:item.retail|mul:0.8 }}" 
                                        width="25" 
                                        height="{{ item.retail|mul:0.8 }}" 
                                        fill="#4e73df" 
                                        rx="3" 
                                        ry="3" />
                                {% endfor %}
                                
                                <!-- Bars for salon usage -->
                                {% for item in report.json_data.monthly_comparison %}
                                    <rect 
                                        x="{{ forloop.counter0|mul:65|add:100 }}" 
                                        y="{{ 250|sub:item.salon|mul:0.8 }}" 
                                        width="25" 
                                        height="{{ item.salon|mul:0.8 }}" 
                                        fill="#1cc88a" 
                                        rx="3" 
                                        ry="3" />
                                {% endfor %}
                                
                                <!-- Legend -->
                                <rect x="400" y="30" width="15" height="15" fill="#4e73df" rx="2" ry="2" />
                                <text x="420" y="43" font-size="12" fill="#333333">Retail Sales</text>
                                <rect x="500" y="30" width="15" height="15" fill="#1cc88a" rx="2" ry="2" />
                                <text x="520" y="43" font-size="12" fill="#333333">Salon Usage</text>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Top Products Comparison -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="fas fa-shopping-cart me-2 text-primary"></i> Top Retail Products</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Product</th>
                                        <th class="text-center">Quantity</th>
                                        <th class="text-end">Value</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for product in report.json_data.top_retail_products %}
                                    <tr>
                                        <td>{{ product.product__name }}</td>
                                        <td class="text-center">{{ product.total_quantity }}</td>
                                        <td class="text-end">MWK {{ product.total_value|floatformat:2 }}</td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="3" class="text-center">No retail sales data available</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="fas fa-cut me-2 text-success"></i> Top Salon Products</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Product</th>
                                        <th class="text-center">Quantity</th>
                                        <th class="text-end">Value</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for product in report.json_data.top_salon_products %}
                                    <tr>
                                        <td>{{ product.product__name }}</td>
                                        <td class="text-center">{{ product.total_quantity }}</td>
                                        <td class="text-end">MWK {{ product.total_value|floatformat:2 }}</td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="3" class="text-center">No salon usage data available</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Raw Data Table -->
    <div class="report-section">
        <h4 class="mb-3">Detailed Data</h4>
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Raw Data</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                {% for header in table_headers %}
                                <th>{{ header }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% if table_data %}
                                {% for row in table_data %}
                                <tr>
                                    {% for cell in row %}
                                    <td>{{ cell }}</td>
                                    {% endfor %}
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="{% if table_headers %}{{ table_headers|length }}{% else %}3{% endif %}" class="text-center py-4">
                                        <i class="fas fa-info-circle text-info me-2"></i>
                                        No data available for this report. Data will appear here once transactions are recorded in the system.
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Parse the JSON data from the template
        const reportData = JSON.parse('{{ report.json_data|safe|escapejs }}');
        
        // Set up Chart.js defaults
        Chart.defaults.font.family = "'Poppins', 'Helvetica', 'Arial', sans-serif";
        Chart.defaults.font.size = 12;
        Chart.defaults.color = '#666';
        
        // Create charts based on report type
        const reportType = '{{ report.report_type }}';
        
        // Business Report Charts
        if (reportType === 'business') {
            // Revenue Breakdown Chart
            if (document.getElementById('revenueChart')) {
                new Chart(document.getElementById('revenueChart'), {
                    type: 'pie',
                    data: {
                        labels: reportData.revenue_breakdown.labels,
                        datasets: [{
                            data: reportData.revenue_breakdown.data,
                            backgroundColor: [
                                '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right'
                            }
                        }
                    }
                });
            }
            
            // Appointment Status Chart
            if (document.getElementById('appointmentChart')) {
                new Chart(document.getElementById('appointmentChart'), {
                    type: 'doughnut',
                    data: {
                        labels: reportData.appointment_status.labels,
                        datasets: [{
                            data: reportData.appointment_status.data,
                            backgroundColor: [
                                '#1cc88a', '#e74a3b', '#f6c23e', '#858796'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right'
                            }
                        }
                    }
                });
            }
        }
        
        // Sales Report Charts
        if (reportType === 'sales') {
            // Sales Trend Chart
            if (document.getElementById('salesTrendChart')) {
                // SVG chart for sales trend
                const salesTrendChart = document.getElementById('salesTrendChart');
                const salesTrendSvg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                salesTrendSvg.setAttribute('width', '100%');
                salesTrendSvg.setAttribute('height', '300');
                salesTrendSvg.setAttribute('viewBox', '0 0 600 300');
                salesTrendSvg.style.backgroundColor = 'white';
                
                // Title
                const title = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                title.setAttribute('x', '300');
                title.setAttribute('y', '30');
                title.setAttribute('text-anchor', 'middle');
                title.setAttribute('font-size', '16');
                title.setAttribute('font-weight', 'bold');
                title.textContent = 'Daily Sales Trend';
                salesTrendSvg.appendChild(title);
                
                // X-axis
                const xAxis = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                xAxis.setAttribute('x1', '50');
                xAxis.setAttribute('y1', '250');
                xAxis.setAttribute('x2', '550');
                xAxis.setAttribute('y2', '250');
                xAxis.setAttribute('stroke', '#ccc');
                xAxis.setAttribute('stroke-width', '1');
                salesTrendSvg.appendChild(xAxis);
                
                // Y-axis
                const yAxis = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                yAxis.setAttribute('x1', '50');
                yAxis.setAttribute('y1', '250');
                yAxis.setAttribute('x2', '50');
                yAxis.setAttribute('y2', '50');
                yAxis.setAttribute('stroke', '#ccc');
                yAxis.setAttribute('stroke-width', '1');
                salesTrendSvg.appendChild(yAxis);
                
                // X-axis labels (dates)
                for (let i = 0; i < reportData.daily_sales.length; i++) {
                    if (i % 3 === 0 || i === 0 || i === reportData.daily_sales.length - 1) {
                        const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                        label.setAttribute('x', (i * 500 / reportData.daily_sales.length) + 50);
                        label.setAttribute('y', '270');
                        label.setAttribute('text-anchor', 'middle');
                        label.setAttribute('font-size', '10');
                        label.setAttribute('fill', '#333333');
                        label.setAttribute('transform', 'rotate(45, ' + ((i * 500 / reportData.daily_sales.length) + 50) + ', 270)');
                        label.textContent = reportData.daily_sales[i].date.slice(5);
                        salesTrendSvg.appendChild(label);
                    }
                }
                
                // Find max value for scaling
                let maxValue = 0;
                for (let i = 0; i < reportData.daily_sales.length; i++) {
                    if (reportData.daily_sales[i].total_revenue > maxValue) {
                        maxValue = reportData.daily_sales[i].total_revenue;
                    }
                }
                
                if (maxValue > 0) {
                    // Line chart for sales trend
                    const polyline = document.createElementNS('http://www.w3.org/2000/svg', 'polyline');
                    polyline.setAttribute('points', '');
                    polyline.setAttribute('fill', 'none');
                    polyline.setAttribute('stroke', '#4e73df');
                    polyline.setAttribute('stroke-width', '2');
                    let points = '';
                    for (let i = 0; i < reportData.daily_sales.length; i++) {
                        points += ((i * 500 / reportData.daily_sales.length) + 50) + ',' + (250 - (reportData.daily_sales[i].total_revenue * 200 / maxValue) + 50) + ' ';
                    }
                    polyline.setAttribute('points', points);
                    salesTrendSvg.appendChild(polyline);
                    
                    // Data points
                    for (let i = 0; i < reportData.daily_sales.length; i++) {
                        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                        circle.setAttribute('cx', (i * 500 / reportData.daily_sales.length) + 50);
                        circle.setAttribute('cy', (250 - (reportData.daily_sales[i].total_revenue * 200 / maxValue) + 50));
                        circle.setAttribute('r', '4');
                        circle.setAttribute('fill', '#4e73df');
                        salesTrendSvg.appendChild(circle);
                    }
                } else {
                    // Show a message when all values are zero
                    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    text.setAttribute('x', '300');
                    text.setAttribute('y', '150');
                    text.setAttribute('text-anchor', 'middle');
                    text.setAttribute('font-size', '14');
                    text.textContent = 'No revenue data available for this period';
                    salesTrendSvg.appendChild(text);
                }
                
                salesTrendChart.innerHTML = '';
                salesTrendChart.appendChild(salesTrendSvg);
            }
            
            // Product vs Service Revenue Chart
            if (document.getElementById('revenueTypeChart')) {
                // SVG chart for product vs service revenue
                const revenueTypeChart = document.getElementById('revenueTypeChart');
                const revenueTypeSvg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                revenueTypeSvg.setAttribute('width', '100%');
                revenueTypeSvg.setAttribute('height', '300');
                revenueTypeSvg.setAttribute('viewBox', '0 0 400 300');
                revenueTypeSvg.style.backgroundColor = 'white';
                
                // Title
                const title = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                title.setAttribute('x', '200');
                title.setAttribute('y', '30');
                title.setAttribute('text-anchor', 'middle');
                title.setAttribute('font-size', '16');
                title.setAttribute('font-weight', 'bold');
                title.textContent = 'Revenue Distribution';
                revenueTypeSvg.appendChild(title);
                
                // Pie chart
                const productRevenue = reportData.revenue_breakdown.data[0];
                const serviceRevenue = reportData.revenue_breakdown.data[1];
                const totalRevenue = productRevenue + serviceRevenue;
                const productPercentage = (productRevenue / totalRevenue) * 100;
                const servicePercentage = (serviceRevenue / totalRevenue) * 100;
                const productAngle = productPercentage * 3.6;
                const serviceAngle = servicePercentage * 3.6;
                
                // Service Revenue slice (starts at 12 o'clock)
                const serviceSlice = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                serviceSlice.setAttribute('d', 'M 200 150 L 200 50 A 100 100 0 ' + (serviceAngle / 360) + ' 1 ' + (200 + (100 * serviceAngle / 360) - 100) + ' ' + (150 - (100 * serviceAngle / 360) + 100) + ' Z');
                serviceSlice.setAttribute('fill', '#1cc88a');
                revenueTypeSvg.appendChild(serviceSlice);
                
                // Product Revenue slice
                const productSlice = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                productSlice.setAttribute('d', 'M 200 150 L ' + (200 + (100 * serviceAngle / 360) - 100) + ' ' + (150 - (100 * serviceAngle / 360) + 100) + ' A 100 100 0 ' + (productAngle / 360) + ' 1 200 50 Z');
                productSlice.setAttribute('fill', '#4e73df');
                revenueTypeSvg.appendChild(productSlice);
                
                // Labels
                const productLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                productLabel.setAttribute('x', '200');
                productLabel.setAttribute('y', '220');
                productLabel.setAttribute('text-anchor', 'middle');
                productLabel.setAttribute('font-size', '14');
                productLabel.setAttribute('font-weight', 'bold');
                productLabel.textContent = 'Products: ' + productPercentage.toFixed(1) + '% (MWK ' + productRevenue.toFixed(2) + ')';
                revenueTypeSvg.appendChild(productLabel);
                
                const serviceLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                serviceLabel.setAttribute('x', '200');
                serviceLabel.setAttribute('y', '245');
                serviceLabel.setAttribute('text-anchor', 'middle');
                serviceLabel.setAttribute('font-size', '14');
                serviceLabel.setAttribute('font-weight', 'bold');
                serviceLabel.textContent = 'Services: ' + servicePercentage.toFixed(1) + '% (MWK ' + serviceRevenue.toFixed(2) + ')';
                revenueTypeSvg.appendChild(serviceLabel);
                
                // Legend
                const productLegend = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                productLegend.setAttribute('x', '80');
                productLegend.setAttribute('y', '270');
                productLegend.setAttribute('width', '15');
                productLegend.setAttribute('height', '15');
                productLegend.setAttribute('fill', '#4e73df');
                productLegend.setAttribute('rx', '2');
                productLegend.setAttribute('ry', '2');
                revenueTypeSvg.appendChild(productLegend);
                
                const productServiceLegend = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                productServiceLegend.setAttribute('x', '100');
                productServiceLegend.setAttribute('y', '283');
                productServiceLegend.setAttribute('font-size', '12');
                productServiceLegend.setAttribute('fill', '#333333');
                productServiceLegend.textContent = 'Products';
                revenueTypeSvg.appendChild(productServiceLegend);
                
                const serviceLegend = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                serviceLegend.setAttribute('x', '250');
                serviceLegend.setAttribute('y', '270');
                serviceLegend.setAttribute('width', '15');
                serviceLegend.setAttribute('height', '15');
                serviceLegend.setAttribute('fill', '#1cc88a');
                serviceLegend.setAttribute('rx', '2');
                serviceLegend.setAttribute('ry', '2');
                revenueTypeSvg.appendChild(serviceLegend);
                
                const serviceServiceLegend = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                serviceServiceLegend.setAttribute('x', '270');
                serviceServiceLegend.setAttribute('y', '283');
                serviceServiceLegend.setAttribute('font-size', '12');
                serviceServiceLegend.setAttribute('fill', '#333333');
                serviceServiceLegend.textContent = 'Services';
                revenueTypeSvg.appendChild(serviceServiceLegend);
                
                revenueTypeChart.innerHTML = '';
                revenueTypeChart.appendChild(revenueTypeSvg);
            }
        }
        
        // Create other charts based on report type...
        // (Similar pattern for other report types)
    });
</script>
{% endblock %}